###############################################
## MaxScale configuration for Galera Cluster ##
## Kester Riley <kester.riley@mariadb.com>   ##
## March 2020                                ##
###############################################

[MaxScale]
# Enable or disable the substitution of environment variables in the MaxScale configuration file
substitute_variables=true
# Send output to Syslog 0 Disabled / 1 Enabled
syslog=0
# The number of worker threads that are handling the events coming from the kernel.
threads=auto
# Enable or disable the logging of messages whose syslog priority is info
log_info=off
# Enable or disable the logging of messages whose syslog priority is notice
log_notice=on
# Enable or disable the logging of messages whose syslog priority is warning
log_warning=off
# Enable or disable the logging of messages whose syslog priority is debug
log_debug=off
# Enable the setting of making this a active / passive cluster
passive=$MAX_PASSIVE


############################################
## Settings for splitting read and writes ##
############################################

[ReadWriteSplit-Service]
localhost_match_wildcard_host=1
router=readwritesplit
servers=db1,db2,db3
type=service
user=$SERVICE_USER
password=$SERVICE_PWD
# Set a Version Name to identify a host
version_string=$MAX_SERVER-rwsplitService

[ReadWriteSplit-Listener]
address=$READ_WRITE_LISTEN_ADDRESS
port=$READ_WRITE_PORT
protocol=$READ_WRITE_PROTOCOL
service=ReadWriteSplit-Service
type=listener

####################################################
## Settings for sending all traffic to the master ##
####################################################

[MasterOnly-Service]
localhost_match_wildcard_host=1
router_options=master
router=readconnroute
servers=db1,db2,db3
type=service
user=$SERVICE_USER
password=$SERVICE_PWD
version_string=$MAX_SERVER-masterOnlyService

[MasterOnly-Listener]
address=$MASTER_ONLY_LISTEN_ADDRESS
port=$MASTER_ONLY_PORT
protocol=$MASTER_ONLY_PROTOCOL
service=MasterOnly-Service
type=listener

################################
## Monitor for Galera Cluster ##
################################

[Galera-Monitor]
module=galeramon
password=$MONITOR_PWD
servers=db1,db2,db3
type=monitor
use_priority=true
user=$MONITOR_USER
disable_master_failback=true
backend_connect_timeout=6
backend_write_timeout=4
backend_read_timeout=2

################################
## List of Servers referenced ##
################################

[db1]
type=server
address=$DB1_ADDRESS
port=$DB1_PORT
protocol=MariaDBBackend
priority=$DB1_PRIO

[db2]
type=server
address=$DB2_ADDRESS
port=$DB2_PORT
protocol=MariaDBBackend
priority=$DB2_PRIO

[db3]
type=server
address=$DB3_ADDRESS
port=$DB3_PORT
protocol=MariaDBBackend
priority=$DB3_PRIO

#############################
## Used for Binlog Routing ##
#############################

[BinlogRouting-Service]
type=service
servers=db1,db2,db3
router=binlogrouter
user=$SERVICE_USER
password=$SERVICE_PWD
server_id=1001003
binlogdir=/var/lib/maxscale/
heartbeat=60
burstsize=1M

[BinlogRouting-Listener]
type=listener
service=BinlogRouting-Service
protocol=$BINLOG_PROTOCOL
port=$BINLOG_PORT
